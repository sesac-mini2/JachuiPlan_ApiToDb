# 성능 테스트 가이드

## 개요
이 스크립트는 Git 커밋 간의 API 요청 및 데이터 삽입 성능을 비교하는 자동화된 테스트를 제공합니다.

## 사용 방법

### 1. 직접 실행
```bash
# 특정 커밋과 최신 상태 비교
node performance/performance-test.js <commit>

# 두 커밋 간의 비교
node performance/performance-test.js <commit1> <commit2>
```

### 2. npm 스크립트 실행 (매개변수 전달)
```bash
# 특정 커밋과 최신 상태 비교
npm run performance-test -- 610a6de

# 두 커밋 간의 비교
npm run performance-test -- 610a6de b89f7c2
```

## 사용 예시

### 1개 커밋 입력 (커밋 vs 최신 상태)
```bash
node performance/performance-test.js 610a6de
```
- `610a6de` 커밋 상태에서 테스트 실행
- 최신 상태에서 테스트 실행
- 두 결과를 비교하여 성능 개선 확인

### 2개 커밋 입력 (커밋 vs 커밋)
```bash
node performance/performance-test.js 610a6de b89f7c2
```
- `610a6de` 커밋 상태에서 테스트 실행
- `b89f7c2` 커밋 상태에서 테스트 실행
- 두 커밋 간의 성능 차이 비교

## 테스트 프로세스

1. **현재 상태 백업**: 현재 Git 상태와 변경사항을 스태시에 저장
2. **이전 버전 테스트**: `git reset --hard HEAD~1`로 이전 커밋으로 되돌린 후 성능 테스트 실행
3. **최신 버전 테스트**: `git pull`로 최신 상태를 가져온 후 성능 테스트 실행
4. **결과 비교**: 두 버전의 성능을 비교하여 개선사항 확인
5. **상태 복원**: 원래 Git 상태로 복원

## 테스트 설정

현재 테스트 설정은 다음과 같습니다:
- **기간**: 2024년 11월 (202411)
- **지역**: 용산구 (11170)만 테스트하여 빠른 실행
- **반복 횟수**: 각 커밋당 10회 측정하여 평균값 계산

설정을 변경하려면 `performance/performance-test.js`의 `testConfig` 객체를 수정하세요:

```javascript
this.testConfig = {
    startYearMonth: "202411",
    endYearMonth: "202411",
    testRegionCodes: ["11170"], // 여러 지역 추가 가능
    repeatCount: 10 // 측정 반복 횟수
};
```

## 측정 방식

각 커밋에 대해 다음과 같은 방식으로 측정합니다:
1. **10회 반복 측정**: 각 커밋 상태에서 10번 실행
2. **통계 계산**: 평균, 최소, 최대, 표준편차, 변동계수 계산
3. **신뢰성 향상**: 네트워크 지연, 시스템 부하 등의 영향을 평균화
4. **성공률 측정**: 실패한 측정을 제외한 성공률 계산

## 결과 파일

테스트 완료 후 다음과 같은 JSON 파일이 `performance/` 디렉토리에 생성됩니다:
- `performance-test-results-[timestamp].json`

결과 파일에는 다음 정보가 포함됩니다:
- 각 테스트의 상세 소요시간
- Git 상태 정보
- 성능 비교 요약
- 오류 정보 (있는 경우)

## 측정 항목

- **평균 소요시간**: 10회 측정의 평균값
- **최소/최대 소요시간**: 가장 빠른/느린 측정값
- **표준편차**: 측정값들의 분산 정도
- **변동계수**: 표준편차를 평균으로 나눈 값 (%)
- **성공률**: 전체 측정 중 성공한 측정의 비율

## ⚠️ 주의사항

- 테스트 실행 전에 현재 작업을 커밋하거나 백업하세요
- 데이터베이스 연결이 필요합니다
- **테스트 중에는 다른 Git 작업을 하지 마세요**
- 테스트 완료 후 자동으로 원래 상태로 복원됩니다
- **⚠️ 데이터베이스 롤백 불가**: 현재 구조에서는 테스트 중 Oracle DB에 실제로 데이터가 삽입되며, 이를 자동으로 롤백할 수 없습니다
- **테스트 환경 권장**: 가능하면 운영 DB가 아닌 테스트 전용 DB에서 실행하세요

## 🛠️ 트랜잭션 관리 한계

현재 구조에서는 다음과 같은 이유로 자동 롤백이 어렵습니다:

### 구조적 문제점
- **Auto-commit**: 각 `insertMany` 호출마다 즉시 커밋 실행
- **분산된 작업**: 여러 테이블에 순차적으로 데이터 삽입
- **긴 실행 시간**: 전체 프로세스가 몇 분에서 몇 시간 소요
- **API-DB 혼재**: API 호출과 DB 작업이 복합적으로 진행

### 권장 대안
1. **테스트 전용 DB 사용**: 운영 DB와 분리된 환경에서 테스트
2. **백업 스크립트 활용**: 테스트 전 수동으로 관련 테이블 백업

## 문제 해결

### Git 상태 복원 실패
```bash
git stash list  # 스태시 목록 확인
git stash pop   # 수동 복원
```

### 테스트 중단 시
```bash
git status      # 현재 상태 확인
git checkout [original-branch]  # 원래 브랜치로 이동
git stash pop   # 백업된 변경사항 복원
```
